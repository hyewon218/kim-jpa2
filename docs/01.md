# API ê°œë°œ ê³ ê¸‰ - ì§€ì—° ë¡œë”©ê³¼ ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”
ì£¼ë¬¸ + ë°°ì†¡ì •ë³´ + íšŒì›ì„ ì¡°íšŒí•˜ëŠ” APIë¥¼ ë§Œë“¤ì
ì§€ì—° ë¡œë”© ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ì„±ëŠ¥ ë¬¸ì œë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ í•´ê²°í•´ë³´ì.

> ğŸ§‘ğŸ»â€ğŸ« JPAë¥¼ ì“°ë©´ì„œ n+1 ë¬¸ì œë¥¼ ì‹¤ì „ì—ì„œ ê²½í—˜í•˜ê²Œ ëœë‹¤.<br>
> ì¿¼ë¦¬ í•œë‘ê°œë¡œ í•´ê²°ë  ê²Œ ì¿¼ë¦¬ê°€ ìˆ˜ì‹­ê°œê°€ ë‚˜ê°€ê²Œ ë˜ëŠ” ê²½ìš° â†’ ì„±ëŠ¥ì €í•˜<br>
> ê·¸ëŸ° ê²ƒë“¤ì„ ì–´ë–»ê²Œ ìµœì í™”í•˜ëŠ”ì§€ ì•Œì•„ë³´ì!

## ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V1: ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë…¸ì¶œ
```java
/**
 *
 * xToOne(ManyToOne, OneToOne) ê´€ê³„ ìµœì í™”
 * Order
 * Order -> Member(ManyToOne)
 * Order -> Delivery(OneToOne)
 *
 */
@RestController
@RequiredArgsConstructor
public class OrderSimpleApiController {

    private final OrderRepository orderRepository;
    private final OrderSimpleQueryRepository orderSimpleQueryRepository; // ì˜ì¡´ê´€ê³„ ì£¼ì…

    /**
     * V1. ì—”í‹°í‹° ì§ì ‘ ë…¸ì¶œ
     * - Hibernate5Module ëª¨ë“ˆ ë“±ë¡, LAZY=null ì²˜ë¦¬
     * - ì–‘ë°©í–¥ ê´€ê³„ ë¬¸ì œ ë°œìƒ -> @JsonIgnore
     */
    @GetMapping("/api/v1/simple-orders")
    public List<Order> ordersV1() {
        List<Order> all = orderRepository.findAllByString(new OrderSearch());
        for (Order order : all) {
            // FORCE_LAZY_LOADING ì˜µì…˜ ë„ê³  ì›í•˜ëŠ” ê²ƒë§Œ ê³¨ë¼ì„œ ì¶œë ¥í•˜ëŠ” ë°©ë²•
            // order.getMember() -> ì—¬ê¸°ê¹Œì§€ í”„ë¡ì‹œ ê°ì²´(DBì— ì¿¼ë¦¬ê°€ ì•ˆ ë‚ ì•„ê°)
            order.getMember().getName(); //Lazy ê°•ì œ ì´ˆê¸°í™”
            order.getDelivery().getAddress(); //Lazy ê°•ì œ ì´ˆê¸°í™”
        }
        return all;
    }
}
```
- ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë…¸ì¶œí•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤.(ì•ì¥ì—ì„œ ì´ë¯¸ ì„¤ëª…)
- `order` -> `member` ì™€ `order` -> `address` ëŠ” ì§€ì—°ë¡œë”©ì´ë‹¤. ë”°ë¼ì„œ ì‹¤ì œ ì—”í‹°í‹° ëŒ€ì‹ ì— í”„ë¡ì‹œ ì¡´ì¬
- jackson ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì´ í”„ë¡ì‹œ ê°ì²´ë¥¼ jsonìœ¼ë¡œ ì–´ë–»ê²Œ ìƒì„±í•´ì•¼ í•˜ëŠ”ì§€ ëª¨ë¦„ -> ì˜ˆì™¸ ë°œìƒ 
- `Hibernate5Module`ì„ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ë©´ í•´ê²° (ìŠ¤í”„ë§ ë¶€íŠ¸ ì‚¬ìš©ì¤‘)

#### ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0 ì´ìƒ: Hibernate5JakartaModule ë“±ë¡
```groovy
implementation 'com.fasterxml.jackson.datatype:jackson-datatype-hibernate5-jakarta'
```
#### JpashopApplication ì— ë‹¤ìŒ ì½”ë“œ ì¶”ê°€
```java
   @Bean
    Hibernate5JakartaModule hibernate5JakartaModule() {
        // ê¸°ë³¸ì ìœ¼ë¡œ ì´ˆê¸°í™” ëœ í”„ë¡ì‹œ ê°ì²´ë§Œ ë…¸ì¶œ
        Hibernate5JakartaModule hibernate5JakartaModule = new Hibernate5JakartaModule();
        return hibernate5JakartaModule;
}
```
- ê¸°ë³¸ì ìœ¼ë¡œ ì´ˆê¸°í™” ëœ í”„ë¡ì‹œ ê°ì²´ë§Œ ë…¸ì¶œ, ì´ˆê¸°í™” ë˜ì§€ ì•Šì€ í”„ë¡ì‹œ ê°ì²´ëŠ” ë…¸ì¶œ ì•ˆí•¨

#### ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•˜ë©´ ê°•ì œë¡œ ì§€ì—° ë¡œë”© ê°€ëŠ¥
```java
    @Bean
    Hibernate5JakartaModule hibernate5JakartaModule() {
        // ê¸°ë³¸ì ìœ¼ë¡œ ì´ˆê¸°í™” ëœ í”„ë¡ì‹œ ê°ì²´ë§Œ ë…¸ì¶œ
        Hibernate5JakartaModule hibernate5JakartaModule = new Hibernate5JakartaModule();
        // V1. ê°•ì œ ì§€ì—° ë¡œë”© ì„¤ì •
        // hibernate5JakartaModule.configure(Hibernate5JakartaModule.Feature.FORCE_LAZY_LOADING, true);
        return hibernate5JakartaModule;
    }
```
- ì´ ì˜µì…˜ì„ í‚¤ë©´ `order` -> `member` , `member` -> `orders` ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ ê³„ì† ë¡œë”©í•˜ê²Œ ëœë‹¤.<br>
- ë”°ë¼ì„œ @JsonIgnore ì˜µì…˜ì„ í•œê³³ì— ì£¼ì–´ì•¼ í•œë‹¤.

> ì£¼ì˜: ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë…¸ì¶œí•  ë•ŒëŠ” ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ê°€ ê±¸ë¦° ê³³ì€ ê¼­! í•œê³³ì„ @JsonIgnore ì²˜ë¦¬ í•´ì•¼ í•œë‹¤.<br>
> ì•ˆ ê·¸ëŸ¬ë©´ ì–‘ìª½ì„ ì„œë¡œ í˜¸ì¶œí•˜ë©´ì„œ ë¬´í•œ ë£¨í”„ê°€ ê±¸ë¦°ë‹¤.

> ì°¸ê³ : ì•ì—ì„œ ê³„ì† ê°•ì¡°í–ˆë“¯ì´ ì •ë§ ê°„ë‹¨í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì•„ë‹ˆë©´ ì—”í‹°í‹°ë¥¼ API ì‘ë‹µìœ¼ë¡œ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤.<br>
> ë”°ë¼ì„œ Hibernate5Module ë¥¼ ì‚¬ìš©í•˜ê¸° ë³´ë‹¤ëŠ” DTOë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜í•˜ëŠ” ê²ƒì´ ë” ì¢‹ì€ ë°©ë²•ì´ë‹¤.

> ì£¼ì˜: ì§€ì—° ë¡œë”©(LAZY)ì„ í”¼í•˜ê¸° ìœ„í•´ ì¦‰ì‹œ ë¡œë”©(EARGR)ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì•ˆ ëœë‹¤! 
> ì¦‰ì‹œ ë¡œë”© ë•Œë¬¸ì— ì—°ê´€ê´€ê³„ê°€ í•„ìš” ì—†ëŠ” ê²½ìš°ì—ë„ ë°ì´í„°ë¥¼ í•­ìƒ ì¡°íšŒí•´ì„œ ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì„±ëŠ¥ íŠœë‹ì´ ë§¤ìš° ì–´ë ¤ì›Œ ì§„ë‹¤.
> í•­ìƒ ì§€ì—° ë¡œë”©ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ê³ , ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•œ ê²½ìš°ì—ëŠ” í˜ì¹˜ ì¡°ì¸(fetch join)ì„ ì‚¬ìš©í•´ë¼!(V3ì—ì„œ ì„¤ëª…)

<br>

## ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V2: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜
```java
   /**
     * V2. ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ DTOë¡œ ë³€í™˜(fetch join ì‚¬ìš©X)
     * - ë‹¨ì : ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì¿¼ë¦¬ Në²ˆ í˜¸ì¶œ
     */
    @GetMapping("/api/v2/simple-orders")
    public List<OrderSimpleDto> ordersV2() {
        List<Order> orders = orderRepository.findAll();
        List<OrderSimpleDto> result = orders.stream()
                .map(OrderSimpleDto::new)
                .collect(toList());
        return result;
    }
```
```java
  @Data
  static class SimpleOrderDto {
    private Long orderId;
    private String name;
    private LocalDateTime orderDate; //ì£¼ë¬¸ì‹œê°„ 
    private OrderStatus orderStatus;
    private Address address;
    
    public SimpleOrderDto(Order order) {
          orderId = order.getId();
          name = order.getMember().getName();
          orderDate = order.getOrderDate();
          orderStatus = order.getStatus();
          address = order.getDelivery().getAddress();
    } 
}
```
- ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì´ë‹¤.
- ì¿¼ë¦¬ê°€ ì´ 1 + N + Në²ˆ ì‹¤í–‰ëœë‹¤. (v1ê³¼ ì¿¼ë¦¬ìˆ˜ ê²°ê³¼ëŠ” ê°™ë‹¤.)
  - order ì¡°íšŒ 1ë²ˆ(order ì¡°íšŒ ê²°ê³¼ ìˆ˜ê°€ Nì´ ëœë‹¤.) 
  - order -> member ì§€ì—° ë¡œë”© ì¡°íšŒ Në²ˆ
  - order -> delivery ì§€ì—° ë¡œë”© ì¡°íšŒ Në²ˆ
  - ì˜ˆ) orderì˜ ê²°ê³¼ê°€ 4ê°œë©´ ìµœì•…ì˜ ê²½ìš° 1 + 4 + 4ë²ˆ ì‹¤í–‰ëœë‹¤.(ìµœì•…ì˜ ê²½ìš°)
    - ì§€ì—°ë¡œë”©ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì¡°íšŒí•˜ë¯€ë¡œ, ì´ë¯¸ ì¡°íšŒëœ ê²½ìš° ì¿¼ë¦¬ë¥¼ ìƒëµí•œë‹¤.

<br>

## ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V3: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜ - í˜ì¹˜ ì¡°ì¸ ìµœì í™” 
```java
    /**
     * V3. ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ DTOë¡œ ë³€í™˜(fetch join ì‚¬ìš©O)
     * - fetch joinìœ¼ë¡œ ì¿¼ë¦¬ 1ë²ˆ í˜¸ì¶œ
     */
    @GetMapping("/api/v3/simple-orders")
    public List<OrderSimpleDto> ordersV3() {
        List<Order> orders = orderRepository.findAllWithMemberDelivery();
        List<OrderSimpleDto> result = orders.stream()
                .map(OrderSimpleDto::new)
                .collect(toList());
        return result;
    }
```
```java
    public List<Order> findAllWithMemberDelivery() {
        return em.createQuery(
                "select o from Order o" +
                        " join fetch o.member m" +
                        " join fetch o.delivery d", Order.class)
                .getResultList();
    }
```
- ì—”í‹°í‹°ë¥¼ í˜ì¹˜ ì¡°ì¸(fetch join)ì„ ì‚¬ìš©í•´ì„œ ì¿¼ë¦¬ 1ë²ˆì— ì¡°íšŒ
- í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ `order -> member` , `order -> delivery`ëŠ” ì´ë¯¸ ì¡°íšŒ ëœ ìƒíƒœì´ë¯€ë¡œ ì§€ì—°ë¡œë”© X

<br>

## ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V4: JPAì—ì„œ DTOë¡œ ë°”ë¡œ ì¡°íšŒ
```java
    @GetMapping("/api/v4/simple-orders")
    public List<OrderSimpleQueryDto> ordersV4() {
        return orderSimpleQueryRepository.findOrderDtos();
    }
```
```java
@Repository
@RequiredArgsConstructor
public class OrderSimpleQueryRepository {

    private final EntityManager em;

    public List<OrderSimpleQueryDto> findOrderDtos() {
        return em.createQuery(
                "select new jpabook.kimjpa2.repository.order.simplequery.OrderSimpleQueryDto(o.id, m.name, o.orderDate, o.status, d.address)" +
                        " from Order o" +
                        " join o.member m" +
                        " join o.delivery d", OrderSimpleQueryDto.class)
                .getResultList();
    }
}
```
```java
@Data
public class OrderSimpleQueryDto {

    private Long orderId;
    private String name;
    private LocalDateTime orderDate; //ì£¼ë¬¸ì‹œê°„
    private OrderStatus orderStatus;
    private Address address;

    public OrderSimpleQueryDto(Long orderId, String name, LocalDateTime orderDate, OrderStatus orderStatus, Address address) {
        this.orderId = orderId;
        this.name = name;
        this.orderDate = orderDate;
        this.orderStatus = orderStatus;
        this.address = address;
    }
}
```
- ì¼ë°˜ì ì¸ SQLì„ ì‚¬ìš©í•  ë•Œ ì²˜ëŸ¼ ì›í•˜ëŠ” ê°’ì„ ì„ íƒí•´ì„œ ì¡°íšŒ 
- new ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì„œ JPQLì˜ ê²°ê³¼ë¥¼ DTOë¡œ ì¦‰ì‹œ ë³€í™˜
- SELECT ì ˆì—ì„œ ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ì§ì ‘ ì„ íƒí•˜ë¯€ë¡œ DB ì• í”Œë¦¬ì¼€ì´ì…˜ ë„¤íŠ¸ì›Œí¬ ìš©ëŸ‰ ìµœì í™”(ìƒê°ë³´ë‹¤ ë¯¸ë¹„)
- ë¦¬í¬ì§€í† ë¦¬ ì¬ì‚¬ìš©ì„± ë–¨ì–´ì§, API ìŠ¤í™ì— ë§ì¶˜ ì½”ë“œê°€ ë¦¬í¬ì§€í† ë¦¬ì— ë“¤ì–´ê°€ëŠ” ë‹¨ì 

**ì •ë¦¬**<br>
ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ê±°ë‚˜, DTOë¡œ ë°”ë¡œ ì¡°íšŒí•˜ëŠ” ë‘ê°€ì§€ ë°©ë²•ì€ ê°ê° ì¥ë‹¨ì ì´ ìˆë‹¤. <br>
ë‘˜ì¤‘ ìƒí™©ì— ë”°ë¼ ì„œ ë” ë‚˜ì€ ë°©ë²•ì„ ì„ íƒí•˜ë©´ ëœë‹¤. ì—”í‹°í‹°ë¡œ ì¡°íšŒí•˜ë©´ ë¦¬í¬ì§€í† ë¦¬ ì¬ì‚¬ìš©ì„±ë„ ì¢‹ê³ , ê°œë°œë„ ë‹¨ìˆœí•´ì§„ë‹¤.<br>
ë”°ë¼ì„œ ê¶Œì¥í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

**ì¿¼ë¦¬ ë°©ì‹ ì„ íƒ ê¶Œì¥ ìˆœì„œ**
1. ìš°ì„  ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ì„ ì„ íƒí•œë‹¤.
2. í•„ìš”í•˜ë©´ í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ ì„±ëŠ¥ì„ ìµœì í™” í•œë‹¤. ëŒ€ë¶€ë¶„ì˜ ì„±ëŠ¥ ì´ìŠˆê°€ í•´ê²°ëœë‹¤.
3. ê·¸ë˜ë„ ì•ˆë˜ë©´ DTOë¡œ ì§ì ‘ ì¡°íšŒí•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤.
4. ìµœí›„ì˜ ë°©ë²•ì€ JPAê°€ ì œê³µí•˜ëŠ” ë„¤ì´í‹°ë¸Œ SQLì´ë‚˜ ìŠ¤í”„ë§ JDBC Templateì„ ì‚¬ìš©í•´ì„œ SQLì„ ì§ì ‘ ì‚¬ìš©í•œë‹¤.